name: "Installation Test"

on:
    push:
        branches: [ main ]
    pull_request: ~

jobs:
    test-install:
        runs-on: ubuntu-latest
        
        steps:
            -   name: Checkout bundle code
                uses: actions/checkout@v4
                with:
                    path: my-bundle # Stiahne tvoj bundle do tohto prieÄinka

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.2'
                    extensions: mbstring, xml, ctype, iconv, gd, imagick
                    tools: composer

            -   name: Create Dummy Symfony Project
                run: |
                    composer create-project symfony/skeleton dummy-project
                    cd dummy-project
                    composer config repositories.local '{"type": "path", "url": "../my-bundle"}'

            -   name: Get Composer Cache Directory
                id: composer-cache
                run: |
                    echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            -   name: Cache Composer dependencies
                uses: actions/cache@v4
                with:
                    path: ${{ steps.composer-cache.outputs.dir }}
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-

            -   name: Install Dependencies
                run: |
                    cd dummy-project
                    composer require webapp --no-scripts
                    composer config minimum-stability dev
                    composer config prefer-stable true
                    composer require liip/imagine-bundle
                    composer require tito10047/progressive-image-bundle:dev-main --no-scripts

            -   name: Copy E2E Test Files
                run: |
                    cp -R my-bundle/tests_ete/basic/* dummy-project/
                    # Ensure config files are in the right place if they were not already
                    # (cp -R should handle it, but being explicit for clarity if needed)

            -   name: Run PHP Built-in Server
                run: |
                    cd dummy-project
                    php -S 127.0.0.1:8000 -t public &
                    sleep 5

            -   name: Test URL
                run: |
                    curl -s http://127.0.0.1:8000/test-bundle > response.html
                    RESPONSE=$(cat response.html)
                    
                    if [[ "$RESPONSE" == *"test_800x800.png"* ]]; then
                      echo "Image found in response."
                    else
                      echo "Image NOT found in response!"
                      exit 1
                    fi
                    
                    if [[ "$RESPONSE" == *"progressive-image"* ]]; then
                      echo "Component rendered."
                    else
                      echo "Component NOT rendered!"
                      exit 1
                    fi

            -   name: Upload HTML Response on Failure
                if: failure()
                uses: actions/upload-artifact@v4
                with:
                    name: test-response-html
                    path: response.html