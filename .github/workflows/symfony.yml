# GitHub Action for Symfony with MySQL
name: Tests
on:
    pull_request:
        branches: [ main ]
    push:
        branches:
            - '**'
concurrency:
    group: ci-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true
jobs:
    symfony:
        name: "Tests"
        runs-on: ${{ matrix.operating-system }}

        # Docs: https://docs.github.com/en/actions/using-containerized-services
        strategy:
            fail-fast: false
            matrix:
                php-version:
                    - "8.2"
                    - "8.3"
                    - "8.4"
                    - "8.5"
                symfony:
                    - '6.4.*'
                    - '7.3.*'
                    - '7.4.*'
                    - '8.0.*'
                operating-system:
                    - "ubuntu-latest"
                liip:
                    - "with"
                include:
                    - php-version: "8.4"
                      symfony: "7.4.*"
                      operating-system: "ubuntu-latest"
                      liip: "without"
                exclude:
                    # Symfony 7.3 does not support PHP 8.1
                    -   php-version: "8.1"
                        symfony: '8.0.*'
                        operating-system: "ubuntu-latest"
                    -   php-version: "8.2"
                        symfony: '8.0.*'
                        operating-system: "ubuntu-latest"
                    -   php-version: "8.3"
                        symfony: '8.0.*'
                        operating-system: "ubuntu-latest"
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: "Install PHP"
                uses: "shivammathur/setup-php@v2"
                with:
                    coverage: "pcov"
                    php-version: "${{ matrix.php-version }}"
                    ini-values: memory_limit=-1
                    extensions: imagick

            -   name: "Configure Symfony"
                run: 'composer config extra.symfony.require "${{ matrix.symfony }}"'

            -   name: Get composer cache directory
                id: composer-cache
                run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            -   name: "Cache dependencies"
                uses: "actions/cache@v3"
                with:
                    path: |
                        ~/.composer/cache
                        vendor
                    key: "php-${{ matrix.php-version }}-symfony-${{ matrix.symfony }}-${{ matrix.liip }}"
                    restore-keys: "php-${{ matrix.php-version }}-symfony-${{ matrix.symfony }}-${{ matrix.liip }}"

            -   name: "Install highest dependencies"
                run: |
                    composer global require php-coveralls/php-coveralls
                    if [ "${{ matrix.liip }}" = "without" ]; then
                      echo "Removing liip/imagine-bundle as requested by matrix"
                      composer remove liip/imagine-bundle --dev --no-update
                      # Odstránime lock súbor, aby sme vynútili čistý update bez zmienky o liip
                      rm -f composer.lock
                    fi
                    composer update --no-interaction --no-progress --no-suggest
                    if [ "${{ matrix.liip }}" = "without" ]; then
                      echo "Verifying liip/imagine-bundle is gone"
                      composer show liip/imagine-bundle 2>/dev/null && (echo "Error: liip/imagine-bundle still exists!"; exit 1) || echo "Confirmed: liip/imagine-bundle is removed"
                    fi


            -   name: Execute tests (Unit and Feature tests) via PHPUnit
                env:
                    DATABASE_URL: mysql://root:symfony@127.0.0.1:${{ job.services.mysql.ports['3306'] }}/symfony
                run: vendor/bin/phpunit --coverage-clover build/reports/clover.xml

            - name: Upload coverage results to Coveralls
              env:
                  COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  php-coveralls --coverage_clover=build/reports/clover.xml --json_path=build/reports/coveralls-upload.json -v
