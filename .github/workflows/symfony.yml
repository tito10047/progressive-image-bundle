# GitHub Action for Symfony with MySQL
name: Tests
on:
    pull_request:
        branches: [ main ]
    push:
        branches:
            - '**'
concurrency:
    group: ci-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true
jobs:
    symfony:
        name: "Tests"
        runs-on: ${{ matrix.operating-system }}

        # Docs: https://docs.github.com/en/actions/using-containerized-services
        strategy:
            fail-fast: false
            matrix:
                php-version:
                    - "8.2"
                    - "8.3"
                    - "8.4"
                    - "8.5"
                symfony:
                    - '6.4.*'
                    - '7.3.*'
                    - '7.4.*'
                    - '8.0.*'
                operating-system:
                    - "ubuntu-latest"
                exclude:
                    # Symfony 7.3 does not support PHP 8.1
                    -   php-version: "8.1"
                        symfony: '8.0.*'
                        operating-system: "ubuntu-latest"
                    -   php-version: "8.2"
                        symfony: '8.0.*'
                        operating-system: "ubuntu-latest"
                    -   php-version: "8.3"
                        symfony: '8.0.*'
                        operating-system: "ubuntu-latest"
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: "Install PHP"
                uses: "shivammathur/setup-php@v2"
                with:
                    coverage: "pcov"
                    php-version: "${{ matrix.php-version }}"
                    ini-values: memory_limit=-1
                    extensions: imagick

            -   name: "Configure Symfony"
                run: 'composer config extra.symfony.require "${{ matrix.symfony }}"'

            -   name: Get composer cache directory
                id: composer-cache
                run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            -   name: "Cache dependencies"
                uses: "actions/cache@v3"
                with:
                    path: |
                        ~/.composer/cache
                        vendor
                    key: "php-${{ matrix.php-version }}-symfony-${{ matrix.symfony }}"
                    restore-keys: "php-${{ matrix.php-version }}-symfony-${{ matrix.symfony }}"

            -   name: "Install highest dependencies"
                run: "composer update --no-interaction --no-progress --no-suggest"

            -   name: Execute tests (Unit and Feature tests) via PHPUnit
                run: "composer test"
